const db = require('../models');
const SanPham = db.SanPham;
const LoaiSP = db.LoaiSP;
const { Op } = require('sequelize');
const { deleteOldImage, renameFileByProductId } = require('../middlewares/upload.middleware');

/**
 * GET /api/admin/products
 * L·∫•y danh s√°ch t·∫•t c·∫£ s·∫£n ph·∫©m (bao g·ªìm c·∫£ s·∫£n ph·∫©m ƒë√£ v√¥ hi·ªáu h√≥a)
 */
exports.getAllProducts = async (req, res) => {
  try {
    console.log('üì¶ Admin - L·∫•y danh s√°ch s·∫£n ph·∫©m');
    console.log('üìù Query params:', req.query);

    // L·∫•y parameters t·ª´ query string
    const pageParam = req.query.page;
    const limitParam = req.query.limit;
    const search = req.query.search || '';
    const loaiId = req.query.loaiId || '';
    const enable = req.query.enable || '';

    // Validate v√† parse page parameter
    let page = 1;
    if (pageParam !== undefined) {
      if (!/^\d+$/.test(String(pageParam))) {
        return res.status(400).json({
          success: false,
          message: 'S·ªë trang ph·∫£i l√† s·ªë nguy√™n d∆∞∆°ng l·ªõn h∆°n 0'
        });
      }
      page = parseInt(pageParam);
      if (page < 1) {
        return res.status(400).json({
          success: false,
          message: 'S·ªë trang ph·∫£i l√† s·ªë nguy√™n d∆∞∆°ng l·ªõn h∆°n 0'
        });
      }
    }

    // Validate v√† parse limit parameter
    let limit = 10;
    if (limitParam !== undefined) {
      if (!/^\d+$/.test(String(limitParam))) {
        return res.status(400).json({
          success: false,
          message: 'S·ªë l∆∞·ª£ng s·∫£n ph·∫©m m·ªói trang ph·∫£i t·ª´ 1 ƒë·∫øn 100'
        });
      }
      limit = parseInt(limitParam);
      if (limit < 1 || limit > 100) {
        return res.status(400).json({
          success: false,
          message: 'S·ªë l∆∞·ª£ng s·∫£n ph·∫©m m·ªói trang ph·∫£i t·ª´ 1 ƒë·∫øn 100'
        });
      }
    }

    // T√≠nh offset
    const offset = (page - 1) * limit;

    console.log(`‚úÖ Validated params - Page: ${page}, Limit: ${limit}, Offset: ${offset}`);

    // T·∫°o ƒëi·ªÅu ki·ªán t√¨m ki·∫øm
    const whereCondition = {};

    // T√¨m ki·∫øm theo t√™n s·∫£n ph·∫©m
    if (search.trim()) {
      whereCondition.Ten = {
        [Op.like]: `%${search.trim()}%`
      };
    }

    // L·ªçc theo lo·∫°i s·∫£n ph·∫©m
    if (loaiId && parseInt(loaiId) > 0) {
      whereCondition.LoaiID = parseInt(loaiId);
    }

    // L·ªçc theo tr·∫°ng th√°i Enable
    if (enable === 'true') {
      whereCondition.Enable = true;
    } else if (enable === 'false') {
      whereCondition.Enable = false;
    }
    // N·∫øu enable === '', l·∫•y t·∫•t c·∫£

    console.log('üîç ƒêi·ªÅu ki·ªán t√¨m ki·∫øm:', whereCondition);

    // Truy v·∫•n database v·ªõi ph√¢n trang
    const { count, rows } = await SanPham.findAndCountAll({
      where: whereCondition,
      include: [
        {
          model: LoaiSP,
          as: 'loaiSP',
          attributes: ['ID', 'Ten', 'MoTa']
        }
      ],
      attributes: [
        'ID',
        'Ten',
        'MoTa',
        'GiaBan',
        'Ton',
        'HinhAnhURL',
        'LoaiID',
        'NgayTao',
        'Enable'
      ],
      limit: limit,
      offset: offset,
      order: [['NgayTao', 'DESC']],
      distinct: true
    });

    // T√≠nh to√°n th√¥ng tin ph√¢n trang
    const totalProducts = count;
    const totalPages = Math.ceil(totalProducts / limit);
    const hasNextPage = page < totalPages;
    const hasPrevPage = page > 1;

    // Format d·ªØ li·ªáu tr·∫£ v·ªÅ
    const products = rows.map(product => ({
      id: product.ID,
      ten: product.Ten,
      moTa: product.MoTa,
      giaBan: parseFloat(product.GiaBan),
      ton: product.Ton,
      hinhAnhURL: product.HinhAnhURL,
      loaiID: product.LoaiID,
      ngayTao: product.NgayTao,
      enable: product.Enable,
      loaiSP: product.loaiSP ? {
        id: product.loaiSP.ID,
        ten: product.loaiSP.Ten,
        moTa: product.loaiSP.MoTa
      } : null
    }));

    console.log(`‚úÖ L·∫•y ${products.length}/${totalProducts} s·∫£n ph·∫©m th√†nh c√¥ng`);

    res.status(200).json({
      success: true,
      message: 'L·∫•y danh s√°ch s·∫£n ph·∫©m th√†nh c√¥ng',
      data: {
        products: products,
        pagination: {
          currentPage: page,
          totalPages: totalPages,
          totalProducts: totalProducts,
          productsPerPage: limit,
          hasNextPage: hasNextPage,
          hasPrevPage: hasPrevPage
        },
        filters: {
          search: search.trim() || null,
          loaiId: loaiId || null,
          enable: enable || 'all'
        }
      }
    });

  } catch (error) {
    console.error('‚ùå L·ªói l·∫•y danh s√°ch s·∫£n ph·∫©m:', error);

    if (error.name === 'SequelizeDatabaseError') {
      return res.status(500).json({
        success: false,
        message: 'L·ªói c∆° s·ªü d·ªØ li·ªáu',
        error: process.env.NODE_ENV === 'development' ? error.message : 'Database Error'
      });
    }

    res.status(500).json({
      success: false,
      message: 'L·ªói server n·ªôi b·ªô',
      error: process.env.NODE_ENV === 'development' ? error.message : 'Internal Server Error'
    });
  }
};

/**
 * POST /api/admin/products
 * Th√™m s·∫£n ph·∫©m m·ªõi v·ªõi upload ·∫£nh
 */
exports.createProduct = async (req, res) => {
  try {
    console.log('‚ûï Admin - T·∫°o s·∫£n ph·∫©m m·ªõi');
    console.log('üìù Body data:', req.body);
    console.log('üìÅ File uploaded:', req.file);

    const { Ten, MoTa, GiaBan, Ton, LoaiID } = req.body;

    // Validate input - T√™n, GiaBan, Ton, LoaiID l√† b·∫Øt bu·ªôc
    const errors = [];

    if (!Ten || !Ten.trim()) {
      errors.push('T√™n s·∫£n ph·∫©m l√† b·∫Øt bu·ªôc');
    } else if (Ten.trim().length < 2) {
      errors.push('T√™n s·∫£n ph·∫©m ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±');
    } else if (Ten.trim().length > 200) {
      errors.push('T√™n s·∫£n ph·∫©m kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 200 k√Ω t·ª±');
    }

    if (!GiaBan) {
      errors.push('Gi√° b√°n l√† b·∫Øt bu·ªôc');
    } else if (isNaN(GiaBan) || parseFloat(GiaBan) < 0) {
      errors.push('Gi√° b√°n ph·∫£i l√† s·ªë kh√¥ng √¢m');
    }

    if (!Ton && Ton !== 0 && Ton !== '0') {
      errors.push('S·ªë l∆∞·ª£ng t·ªìn kho l√† b·∫Øt bu·ªôc');
    } else if (isNaN(Ton) || parseInt(Ton) < 0) {
      errors.push('S·ªë l∆∞·ª£ng t·ªìn kho ph·∫£i l√† s·ªë nguy√™n kh√¥ng √¢m');
    }

    if (!LoaiID) {
      errors.push('Lo·∫°i s·∫£n ph·∫©m l√† b·∫Øt bu·ªôc');
    } else if (isNaN(LoaiID) || parseInt(LoaiID) < 1) {
      errors.push('Lo·∫°i s·∫£n ph·∫©m kh√¥ng h·ª£p l·ªá');
    }

    if (MoTa && MoTa.length > 5000) {
      errors.push('M√¥ t·∫£ kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5000 k√Ω t·ª±');
    }

    if (errors.length > 0) {
      // X√≥a file ƒë√£ upload n·∫øu c√≥ l·ªói validation
      if (req.file) {
        deleteOldImage(req.file.filename);
      }
      return res.status(400).json({
        success: false,
        message: 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá',
        errors: errors
      });
    }

    // Ki·ªÉm tra lo·∫°i s·∫£n ph·∫©m c√≥ t·ªìn t·∫°i kh√¥ng
    const loaiSP = await LoaiSP.findOne({
      where: {
        ID: parseInt(LoaiID),
        Enable: true
      }
    });

    if (!loaiSP) {
      // X√≥a file ƒë√£ upload n·∫øu lo·∫°i s·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i
      if (req.file) {
        deleteOldImage(req.file.filename);
      }
      return res.status(404).json({
        success: false,
        message: 'Lo·∫°i s·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã v√¥ hi·ªáu h√≥a'
      });
    }

    // Ki·ªÉm tra t√™n s·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i ch∆∞a
    const existingProduct = await SanPham.findOne({
      where: db.sequelize.where(
        db.sequelize.fn('LOWER', db.sequelize.col('Ten')),
        db.sequelize.fn('LOWER', Ten.trim())
      )
    });

    if (existingProduct) {
      // X√≥a file ƒë√£ upload n·∫øu t√™n tr√πng
      if (req.file) {
        deleteOldImage(req.file.filename);
      }
      return res.status(409).json({
        success: false,
        message: 'T√™n s·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i'
      });
    }

    // T·∫°o s·∫£n ph·∫©m m·ªõi TR∆Ø·ªöC (ƒë·ªÉ c√≥ ID)
    const newProduct = await SanPham.create({
      Ten: Ten.trim(),
      MoTa: MoTa ? MoTa.trim() : null,
      GiaBan: parseFloat(GiaBan),
      Ton: parseInt(Ton),
      LoaiID: parseInt(LoaiID),
      HinhAnhURL: null, // T·∫°m th·ªùi null, s·∫Ω update sau
      Enable: true
    });

    // Rename file theo ID s·∫£n ph·∫©m v√† c·∫≠p nh·∫≠t HinhAnhURL
    let hinhAnhURL = null;
    if (req.file) {
      const newFilename = renameFileByProductId(req.file.filename, newProduct.ID);
      hinhAnhURL = `/uploads/${newFilename}`;
      
      // C·∫≠p nh·∫≠t HinhAnhURL v√†o database
      await newProduct.update({ HinhAnhURL: hinhAnhURL });
    }

    console.log('‚úÖ T·∫°o s·∫£n ph·∫©m m·ªõi th√†nh c√¥ng:', newProduct.Ten);

    // L·∫•y l·∫°i th√¥ng tin s·∫£n ph·∫©m v·ªõi lo·∫°i s·∫£n ph·∫©m
    const productDetail = await SanPham.findOne({
      where: { ID: newProduct.ID },
      include: [{
        model: LoaiSP,
        as: 'loaiSP',
        attributes: ['ID', 'Ten', 'MoTa']
      }]
    });

    res.status(201).json({
      success: true,
      message: 'T·∫°o s·∫£n ph·∫©m m·ªõi th√†nh c√¥ng',
      data: {
        product: {
          id: productDetail.ID,
          ten: productDetail.Ten,
          moTa: productDetail.MoTa,
          giaBan: parseFloat(productDetail.GiaBan),
          ton: productDetail.Ton,
          hinhAnhURL: productDetail.HinhAnhURL,
          loaiID: productDetail.LoaiID,
          ngayTao: productDetail.NgayTao,
          enable: productDetail.Enable,
          loaiSP: productDetail.loaiSP ? {
            id: productDetail.loaiSP.ID,
            ten: productDetail.loaiSP.Ten,
            moTa: productDetail.loaiSP.MoTa
          } : null
        }
      }
    });

  } catch (error) {
    console.error('‚ùå L·ªói t·∫°o s·∫£n ph·∫©m:', error);

    // X√≥a file ƒë√£ upload n·∫øu c√≥ l·ªói
    if (req.file) {
      deleteOldImage(req.file.filename);
    }

    if (error.name === 'SequelizeValidationError') {
      return res.status(400).json({
        success: false,
        message: 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá',
        errors: error.errors.map(err => err.message)
      });
    }

    res.status(500).json({
      success: false,
      message: 'L·ªói server n·ªôi b·ªô',
      error: process.env.NODE_ENV === 'development' ? error.message : 'Internal Server Error'
    });
  }
};

/**
 * PUT /api/admin/products/:id
 * C·∫≠p nh·∫≠t s·∫£n ph·∫©m
 */
exports.updateProduct = async (req, res) => {
  try {
    const productId = parseInt(req.params.id);
    console.log('‚úèÔ∏è Admin - C·∫≠p nh·∫≠t s·∫£n ph·∫©m ID:', productId);
    console.log('üìù Body data:', req.body);
    console.log('üìÅ File uploaded:', req.file);

    // Validate productId
    if (!productId || productId < 1) {
      if (req.file) {
        deleteOldImage(req.file.filename);
      }
      return res.status(400).json({
        success: false,
        message: 'ID s·∫£n ph·∫©m kh√¥ng h·ª£p l·ªá'
      });
    }

    const { Ten, MoTa, GiaBan, Ton, LoaiID, Enable } = req.body;

    // Validate d·ªØ li·ªáu ƒë·∫ßu v√†o
    const errors = [];

    if (Ten !== undefined) {
      if (!Ten || !Ten.trim()) {
        errors.push('T√™n s·∫£n ph·∫©m kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng');
      } else if (Ten.trim().length < 2) {
        errors.push('T√™n s·∫£n ph·∫©m ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±');
      } else if (Ten.trim().length > 200) {
        errors.push('T√™n s·∫£n ph·∫©m kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 200 k√Ω t·ª±');
      }
    }

    if (GiaBan !== undefined) {
      if (isNaN(GiaBan) || parseFloat(GiaBan) < 0) {
        errors.push('Gi√° b√°n ph·∫£i l√† s·ªë kh√¥ng √¢m');
      }
    }

    if (Ton !== undefined) {
      if (isNaN(Ton) || parseInt(Ton) < 0) {
        errors.push('S·ªë l∆∞·ª£ng t·ªìn kho ph·∫£i l√† s·ªë nguy√™n kh√¥ng √¢m');
      }
    }

    if (LoaiID !== undefined) {
      if (isNaN(LoaiID) || parseInt(LoaiID) < 1) {
        errors.push('Lo·∫°i s·∫£n ph·∫©m kh√¥ng h·ª£p l·ªá');
      }
    }

    if (MoTa !== undefined && MoTa && MoTa.length > 5000) {
      errors.push('M√¥ t·∫£ kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5000 k√Ω t·ª±');
    }

    if (Enable !== undefined && typeof Enable !== 'boolean') {
      // Th·ª≠ convert string to boolean
      if (Enable !== 'true' && Enable !== 'false') {
        errors.push('Tr·∫°ng th√°i ph·∫£i l√† true ho·∫∑c false');
      }
    }

    if (errors.length > 0) {
      if (req.file) {
        deleteOldImage(req.file.filename);
      }
      return res.status(400).json({
        success: false,
        message: 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá',
        errors: errors
      });
    }

    // Ki·ªÉm tra s·∫£n ph·∫©m c√≥ t·ªìn t·∫°i kh√¥ng
    const product = await SanPham.findByPk(productId);

    if (!product) {
      if (req.file) {
        deleteOldImage(req.file.filename);
      }
      return res.status(404).json({
        success: false,
        message: 'Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m'
      });
    }

    // Ki·ªÉm tra lo·∫°i s·∫£n ph·∫©m n·∫øu ƒë∆∞·ª£c c·∫≠p nh·∫≠t
    if (LoaiID !== undefined) {
      const loaiSP = await LoaiSP.findOne({
        where: {
          ID: parseInt(LoaiID),
          Enable: true
        }
      });

      if (!loaiSP) {
        if (req.file) {
          deleteOldImage(req.file.filename);
        }
        return res.status(404).json({
          success: false,
          message: 'Lo·∫°i s·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã v√¥ hi·ªáu h√≥a'
        });
      }
    }

    // Ki·ªÉm tra t√™n tr√πng l·∫∑p (n·∫øu t√™n ƒë∆∞·ª£c c·∫≠p nh·∫≠t)
    if (Ten !== undefined && Ten.trim() !== product.Ten) {
      const existingProduct = await SanPham.findOne({
        where: {
          [Op.and]: [
            db.sequelize.where(
              db.sequelize.fn('LOWER', db.sequelize.col('Ten')),
              db.sequelize.fn('LOWER', Ten.trim())
            ),
            { ID: { [Op.ne]: productId } }
          ]
        }
      });

      if (existingProduct) {
        if (req.file) {
          deleteOldImage(req.file.filename);
        }
        return res.status(409).json({
          success: false,
          message: 'T√™n s·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i'
        });
      }
    }

    // T·∫°o object d·ªØ li·ªáu c·∫ßn c·∫≠p nh·∫≠t
    const updateData = {};

    if (Ten !== undefined) {
      updateData.Ten = Ten.trim();
    }

    if (MoTa !== undefined) {
      updateData.MoTa = MoTa ? MoTa.trim() : null;
    }

    if (GiaBan !== undefined) {
      updateData.GiaBan = parseFloat(GiaBan);
    }

    if (Ton !== undefined) {
      updateData.Ton = parseInt(Ton);
    }

    if (LoaiID !== undefined) {
      updateData.LoaiID = parseInt(LoaiID);
    }

    if (Enable !== undefined) {
      updateData.Enable = Enable === 'true' || Enable === true;
    }

    // X·ª≠ l√Ω upload ·∫£nh m·ªõi
    if (req.file) {
      // X√≥a ·∫£nh c≈© n·∫øu c√≥
      if (product.HinhAnhURL) {
        deleteOldImage(product.HinhAnhURL);
      }
      
      // Rename file theo ID s·∫£n ph·∫©m
      const newFilename = renameFileByProductId(req.file.filename, productId);
      updateData.HinhAnhURL = `/uploads/${newFilename}`;
    }

    // Ki·ªÉm tra c√≥ d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t kh√¥ng
    if (Object.keys(updateData).length === 0) {
      return res.status(400).json({
        success: false,
        message: 'Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t'
      });
    }

    // C·∫≠p nh·∫≠t s·∫£n ph·∫©m
    await product.update(updateData);

    // L·∫•y l·∫°i th√¥ng tin s·∫£n ph·∫©m ƒë√£ c·∫≠p nh·∫≠t
    const updatedProduct = await SanPham.findOne({
      where: { ID: productId },
      include: [{
        model: LoaiSP,
        as: 'loaiSP',
        attributes: ['ID', 'Ten', 'MoTa']
      }]
    });

    console.log('‚úÖ C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng:', updatedProduct.Ten);

    res.status(200).json({
      success: true,
      message: 'C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng',
      data: {
        product: {
          id: updatedProduct.ID,
          ten: updatedProduct.Ten,
          moTa: updatedProduct.MoTa,
          giaBan: parseFloat(updatedProduct.GiaBan),
          ton: updatedProduct.Ton,
          hinhAnhURL: updatedProduct.HinhAnhURL,
          loaiID: updatedProduct.LoaiID,
          ngayTao: updatedProduct.NgayTao,
          enable: updatedProduct.Enable,
          loaiSP: updatedProduct.loaiSP ? {
            id: updatedProduct.loaiSP.ID,
            ten: updatedProduct.loaiSP.Ten,
            moTa: updatedProduct.loaiSP.MoTa
          } : null
        }
      }
    });

  } catch (error) {
    console.error('‚ùå L·ªói c·∫≠p nh·∫≠t s·∫£n ph·∫©m:', error);

    // X√≥a file m·ªõi upload n·∫øu c√≥ l·ªói
    if (req.file) {
      deleteOldImage(req.file.filename);
    }

    if (error.name === 'SequelizeValidationError') {
      return res.status(400).json({
        success: false,
        message: 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá',
        errors: error.errors.map(err => err.message)
      });
    }

    res.status(500).json({
      success: false,
      message: 'L·ªói server n·ªôi b·ªô',
      error: process.env.NODE_ENV === 'development' ? error.message : 'Internal Server Error'
    });
  }
};

/**
 * DELETE /api/admin/products/:id
 * X√≥a s·∫£n ph·∫©m (soft delete - set Enable = false)
 */
exports.deleteProduct = async (req, res) => {
  try {
    const productId = parseInt(req.params.id);
    console.log('üóëÔ∏è Admin - X√≥a s·∫£n ph·∫©m ID:', productId);

    // Validate productId
    if (!productId || productId < 1) {
      return res.status(400).json({
        success: false,
        message: 'ID s·∫£n ph·∫©m kh√¥ng h·ª£p l·ªá'
      });
    }

    // Ki·ªÉm tra s·∫£n ph·∫©m c√≥ t·ªìn t·∫°i kh√¥ng
    const product = await SanPham.findByPk(productId);

    if (!product) {
      return res.status(404).json({
        success: false,
        message: 'Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m'
      });
    }

    // Ki·ªÉm tra s·∫£n ph·∫©m ƒë√£ b·ªã x√≥a ch∆∞a
    if (!product.Enable) {
      return res.status(400).json({
        success: false,
        message: 'S·∫£n ph·∫©m ƒë√£ b·ªã v√¥ hi·ªáu h√≥a tr∆∞·ªõc ƒë√≥'
      });
    }

    // L∆∞u th√¥ng tin s·∫£n ph·∫©m tr∆∞·ªõc khi x√≥a
    const productName = product.Ten;
    const productImage = product.HinhAnhURL;

    // Soft delete - set Enable = false
    await product.update({ Enable: false });

    // X√≥a ·∫£nh v·∫≠t l√Ω n·∫øu mu·ªën (t√πy ch·ªçn)
    // if (productImage) {
    //   deleteOldImage(productImage);
    // }

    console.log('‚úÖ V√¥ hi·ªáu h√≥a s·∫£n ph·∫©m th√†nh c√¥ng:', productName);

    res.status(200).json({
      success: true,
      message: 'V√¥ hi·ªáu h√≥a s·∫£n ph·∫©m th√†nh c√¥ng',
      data: {
        deletedProduct: {
          id: productId,
          ten: productName,
          hinhAnhURL: productImage
        }
      }
    });

  } catch (error) {
    console.error('‚ùå L·ªói x√≥a s·∫£n ph·∫©m:', error);

    res.status(500).json({
      success: false,
      message: 'L·ªói server n·ªôi b·ªô',
      error: process.env.NODE_ENV === 'development' ? error.message : 'Internal Server Error'
    });
  }
};
